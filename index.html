<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>作戦ボード（プロトタイプ）</title>
  <style>
    body { margin: 0; overflow: hidden; touch-action: none; }
    canvas { position: absolute; top: 0; left: 0; }
    img.icon {
      position: absolute;
      width: 50px;
      height: 50px;
      touch-action: none;
      user-select: none;
    }
    .mode-button, .tool-button {
      position: absolute;
      top: 10px;
      padding: 10px;
      background-color: #fff;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    .tool-button {
      top: 50px;
    }
  </style>
</head>
<body>

<!-- 背景用キャンバス -->
<canvas id="backgroundCanvas"></canvas>

<!-- 描画用キャンバス -->
<canvas id="map"></canvas>

<!-- キャラアイコン（例：味方チーム用） -->
<img src="https://upload.wikimedia.org/wikipedia/commons/8/84/Example.svg" class="icon" id="icon1" style="left: 100px; top: 100px;">

<!-- モード切替ボタン -->
<div id="modeButton" class="mode-button">ペンモード</div>

<!-- ツールボタン -->
<div id="toolButtons" class="tool-button">
  <button id="penButton">ペン</button>
  <button id="eraserButton">消しゴム</button>
  <button id="clearButton">クリア</button>
</div>

<script>
const canvas = document.getElementById('map');
const ctx = canvas.getContext('2d');
const backgroundCanvas = document.getElementById('backgroundCanvas');
const backgroundCtx = backgroundCanvas.getContext('2d');
const modeButton = document.getElementById('modeButton');
const penButton = document.getElementById('penButton');
const eraserButton = document.getElementById('eraserButton');
const clearButton = document.getElementById('clearButton');
let currentMode = 'pen'; // 初期モードはペン
let drawing = false;
let erasing = false;
let lineWidth = 5; // 初期の線の太さ
let strokeStyle = 'red'; // 初期の線の色

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  backgroundCanvas.width = window.innerWidth;
  backgroundCanvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// 背景マップ（ここは好きなマップ画像に変えてOK）
const background = new Image();
background.src = 'https://github.com/nea1228/eternal-return-board/raw/main/image.png';

background.onload = () => {
  const canvasWidth = canvas.width;
  const canvasHeight = canvas.height;

  // 画像の元の幅と高さ
  const imgWidth = background.width;
  const imgHeight = background.height;

  // 縦横比を保つための計算
  const widthRatio = canvasWidth / imgWidth;
  const heightRatio = canvasHeight / imgHeight;
  
  // 縦横比を保つための新しい幅と高さ
  const ratio = Math.min(widthRatio, heightRatio); // 縦横どちらかにフィットするように最小の比率を取る
  const newWidth = imgWidth * ratio;
  const newHeight = imgHeight * ratio;

  // キャンバス内に縦横比を保って描画
  const offsetX = (canvasWidth - newWidth) / 2; // 画像を横方向で中央に配置
  const offsetY = (canvasHeight - newHeight) / 2; // 画像を縦方向で中央に配置

  // 背景画像を中央に配置して描画
  backgroundCtx.clearRect(0, 0, backgroundCanvas.width, backgroundCanvas.height); // 既存の描画を消す
  backgroundCtx.drawImage(background, offsetX, offsetY, newWidth, newHeight);
};

// モード切替ボタンのクリックイベント
modeButton.addEventListener('click', () => {
  if (currentMode === 'pen') {
    currentMode = 'eraser';
    modeButton.textContent = '消しゴムモード';
    erasing = true;
    ctx.globalCompositeOperation = 'destination-out'; // 消去モードに設定
  } else {
    currentMode = 'pen';
    modeButton.textContent = 'ペンモード';
    erasing = false;
    ctx.globalCompositeOperation = 'source-over'; // 通常の描画モードに戻す
  }
});

// ペンツールでお絵描き
canvas.addEventListener('pointerdown', (e) => {
  drawing = true;
  ctx.beginPath();
  ctx.moveTo(e.clientX, e.clientY);
});
canvas.addEventListener('pointermove', (e) => {
  if (drawing) {
    ctx.lineTo(e.clientX, e.clientY);
    ctx.lineWidth = lineWidth;
    ctx.strokeStyle = strokeStyle;
    ctx.stroke();
  }
});
canvas.addEventListener('pointerup', () => {
  drawing = false;
});

// アイコンドラッグ
const icon = document.getElementById('icon1');
let dragging = false;
let offsetX, offsetY;

icon.addEventListener('pointerdown', (e) => {
  dragging = true;
  offsetX = e.offsetX;
  offsetY = e.offsetY;
});
document.addEventListener('pointermove', (e) => {
  if (dragging) {
    icon.style.left = (e.clientX - offsetX) + 'px';
    icon.style.top = (e.clientY - offsetY) + 'px';
  }
});
document.addEventListener('pointerup', () => {
  dragging = false;
});

// ツールボタンのクリックイベント
penButton.addEventListener('click', () => {
  lineWidth = 5;
  strokeStyle = 'red';
});
eraserButton.addEventListener('click', () => {
  lineWidth = 10;
  strokeStyle = 'white';
});
clearButton.addEventListener('click', () => {
  ctx.clearRect(0, 0, canvas.width, canvas.height); // 描画をクリア
  backgroundCtx.clearRect(0, 0, backgroundCanvas.width, backgroundCanvas.height); // 背景もクリア
  backgroundCtx.drawImage(background, 0, 0, backgroundCanvas.width, backgroundCanvas.height); // 背景を再描画
});
</script>

</body>
</html>
