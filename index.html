<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>作戦ボード（プロトタイプ）</title>
  <style>
    body { margin: 0; overflow: hidden; touch-action: none; }
    canvas { position: absolute; top: 0; left: 0; }
    img.icon {
      position: absolute;
      width: 50px;
      height: 50px;
      touch-action: none;
      user-select: none;
    }
    .toolbar {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: rgba(255, 255, 255, 0.7);
      padding: 10px;
      border-radius: 8px;
      z-index: 10;
    }
    .toolbar button {
      margin: 5px;
    }
    .color-picker button {
      width: 30px;
      height: 30px;
      border: none;
      cursor: pointer;
    }
    .active {
      border: 2px solid black;
    }
  </style>
</head>
<body>

<!-- 背景マップ -->
<canvas id="map"></canvas>

<!-- ツールバー -->
<div class="toolbar">
  <h3>ペンツール</h3>
  <div class="color-picker">
    <button style="background-color: red;" data-color="red"></button>
    <button style="background-color: blue;" data-color="blue"></button>
    <button style="background-color: orange;" data-color="orange"></button>
    <button style="background-color: green;" data-color="green"></button>
  </div>
  <br>
  <button id="pen-thin" class="active">細いペン</button>
  <button id="pen-thick">太いペン</button>
  <br>
  <button id="eraser">消しゴム</button>
  <h3>チーム設定</h3>
  <button id="team-red">赤チーム</button>
  <button id="team-blue">青チーム</button>
</div>

<script>
const canvas = document.getElementById('map');
const ctx = canvas.getContext('2d');

// 画面サイズのリサイズ
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// 背景マップ（ここは好きなマップ画像に変えてOK）
const background = new Image();
background.src = 'https://github.com/nea1228/eternal-return-board/raw/main/image.png';

background.onload = () => {
  const canvasWidth = canvas.width;
  const canvasHeight = canvas.height;

  const imgWidth = background.width;
  const imgHeight = background.height;
  
  const widthRatio = canvasWidth / imgWidth;
  const heightRatio = canvasHeight / imgHeight;
  const ratio = Math.min(widthRatio, heightRatio);
  const newWidth = imgWidth * ratio;
  const newHeight = imgHeight * ratio;

  const offsetX = (canvasWidth - newWidth) / 2;
  const offsetY = (canvasHeight - newHeight) / 2;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(background, offsetX, offsetY, newWidth, newHeight);
};

// ペンツールと消しゴム設定
let drawing = false;
let erasing = false;
let currentColor = 'red';
let currentLineWidth = 3;
let currentMode = 'pen'; // 現在のモード

// アイコンを動かすための関数
let dragging = false;
let draggedIcon = null;
let offsetX, offsetY;

// アイコンのデータ
const characters = {
  red: [
    {id: 'icon1', x: 100, y: 100}, 
    {id: 'icon2', x: 200, y: 100}, 
    {id: 'icon3', x: 300, y: 100}
  ],
  blue: [
    {id: 'icon4', x: 100, y: 200}, 
    {id: 'icon5', x: 200, y: 200}, 
    {id: 'icon6', x: 300, y: 200}
  ]
};

// キャラクターアイコンを配置する関数
function placeCharacterIcons(team) {
  const teamData = characters[team];
  teamData.forEach((character) => {
    const icon = document.createElement('img');
    icon.src = 'https://upload.wikimedia.org/wikipedia/commons/8/84/Example.svg'; // アイコン画像
    icon.classList.add('icon');
    icon.style.left = `${character.x}px`;
    icon.style.top = `${character.y}px`;
    icon.dataset.team = team;
    icon.id = character.id;
    document.body.appendChild(icon);

    icon.addEventListener('pointerdown', (e) => {
      dragging = true;
      draggedIcon = icon;
      offsetX = e.offsetX;
      offsetY = e.offsetY;
    });
  });
}

// アイコンをドラッグする
document.addEventListener('pointermove', (e) => {
  if (dragging && draggedIcon) {
    draggedIcon.style.left = (e.clientX - offsetX) + 'px';
    draggedIcon.style.top = (e.clientY - offsetY) + 'px';
  }
});

// ドラッグ終了
document.addEventListener('pointerup', () => {
  dragging = false;
  draggedIcon = null;
});

// ペンツールの操作
canvas.addEventListener('pointerdown', (e) => {
  if (currentMode === 'pen') {
    drawing = true;
    ctx.beginPath();
    ctx.moveTo(e.clientX, e.clientY);
  }
});

canvas.addEventListener('pointermove', (e) => {
  if (drawing && currentMode === 'pen') {
    ctx.lineTo(e.clientX, e.clientY);
    ctx.strokeStyle = currentColor;
    ctx.lineWidth = currentLineWidth;
    ctx.stroke();
  }
});

canvas.addEventListener('pointerup', () => {
  drawing = false;
});

// 消しゴムの操作
document.getElementById('eraser').addEventListener('click', () => {
  currentMode = currentMode === 'eraser' ? 'pen' : 'eraser';
  updateModeButton();
  if (currentMode === 'eraser') {
    erasing = true;
    ctx.globalCompositeOperation = 'destination-out';
  } else {
    erasing = false;
    ctx.globalCompositeOperation = 'source-over';
  }
});

// ペンの色変更
document.querySelectorAll('.color-picker button').forEach(button => {
  button.addEventListener('click', (e) => {
    currentColor = e.target.dataset.color;
  });
});

// ペンの太さ変更
document.getElementById('pen-thin').addEventListener('click', () => {
  currentLineWidth = 3;
  updateLineWidthButton('thin');
});

document.getElementById('pen-thick').addEventListener('click', () => {
  currentLineWidth = 6;
  updateLineWidthButton('thick');
});

// チームの選択
document.getElementById('team-red').addEventListener('click', () => {
  placeCharacterIcons('red');
});

document.getElementById('team-blue').addEventListener('click', () => {
  placeCharacterIcons('blue');
});

// モードボタンの更新
function updateModeButton() {
  document.querySelectorAll('.toolbar button').forEach(button => {
    button.classList.remove('active');
  });
  if (currentMode === 'pen') {
    document.getElementById(currentLineWidth === 3 ? 'pen-thin' : 'pen-thick').classList.add('active');
  } else if (currentMode === 'eraser') {
    document.getElementById('eraser').classList.add('active');
  }
}

// 初期化
updateModeButton();

</script>

</body>
</html>
